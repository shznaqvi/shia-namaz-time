<!DOCTYPE html><html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shia Namaz Timetable Canvas</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; background:#f4f4f4; margin:0; padding:20px; }
canvas { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display:block; margin: 20px auto; }
button { padding:10px 20px; font-size:16px; cursor:pointer; margin-top:10px; display:none; }
</style>
</head>
<body><h2>Daily Shia Namaz Timetable</h2>
<p id="location">Checking location permission...</p>
<p id="date"></p>
<button id="enableBtn" onclick="requestLocation()">Enable GPS Location</button>
<canvas id="namazCanvas" width="400" height="400"></canvas><script src="https://cdn.jsdelivr.net/npm/praytimes@2.3.0/praytimes.js"></script><script>
const prayers = ['Imsak','Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];

function updateDate(){
    const now=new Date();
    const options={ weekday:'long', year:'numeric', month:'long', day:'numeric' };
    document.getElementById('date').innerText = now.toLocaleDateString(undefined, options);
}

function drawCanvas(times){
    const canvas=document.getElementById('namazCanvas');
    const ctx=canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#111';
    ctx.font='16px Arial';

    for(let i=0;i<prayers.length;i++){
        ctx.fillText(`${prayers[i]}: ${times[prayers[i]]}`,50,50+i*40);
    }
}

async function reverseGeocode(lat, lon){
    try{
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
        const data = await res.json();
        return data.address.city || data.address.town || data.address.village || data.address.state || `(${lat.toFixed(3)}, ${lon.toFixed(3)})`;
    } catch {
        return `(${lat.toFixed(3)}, ${lon.toFixed(3)})`;
    }
}

function requestLocation(){
    navigator.geolocation.getCurrentPosition(async function(position){
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const timezone = -new Date().getTimezoneOffset()/60;

        const city = await reverseGeocode(lat, lon);
        updateDate();
        document.getElementById('location').innerText = 'Location: ' + city;
        document.getElementById('enableBtn').style.display = 'none';

        const prayTimes = new PrayTimes('Jafari');
        prayTimes.adjust({'imsak': 10, 'fajr': 17.5, 'isha': 14});
        const times = prayTimes.getTimes(new Date(), [lat, lon], timezone);

        drawCanvas(times);
        scheduleNextRefresh();

    }, function(){
        document.getElementById('location').innerText = 'Location permission denied.';
        document.getElementById('enableBtn').style.display = 'inline-block';
        updateDate();
    });
}

function scheduleNextRefresh(){
    const now = new Date();
    const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0);
    const msUntilMidnight = nextMidnight - now;
    setTimeout(requestLocation, msUntilMidnight);
}

window.onload = async function(){
    if(!navigator.geolocation){
        document.getElementById('location').innerText = 'Geolocation not supported by browser.';
        updateDate();
        return;
    }

    if(navigator.permissions){
        const permission = await navigator.permissions.query({ name: 'geolocation' });

        if(permission.state === 'granted'){
            requestLocation();
        }
        else if(permission.state === 'prompt'){
            requestLocation();
        }
        else {
            document.getElementById('location').innerText = 'Location permission blocked. Please enable manually.';
            document.getElementById('enableBtn').style.display = 'inline-block';
            updateDate();
        }
    } else {
        requestLocation();
    }
};
</script></body>
</html>